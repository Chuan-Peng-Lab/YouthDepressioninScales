---
title: "Untitled"
author: "why"
date: "2025-11-15"
output: html_document
---

```{r}
# 预处理是将RAWDATA1和Complains_YoungClients（即未经处理的医生原始数据）进行处理的代码，处理规则如下：
# 在本研究的数据预处理中，Rawdata1.xlsx 与 Complains_YoungClients.xls 两个数据表均包含重复的 ID。
# 为了确保后续分析中每个 ID 仅保留一条最合适的记录，我们制定并实施了如下匹配与筛选规则：
# 1. 两个数据表均出现的 ID（共同 ID）
# 当某个 ID 同时存在于 Rawdata1 与 Complains 数据表中，且各自都可能有多条记录时：
# 规则：找到 Raw 中每条记录与 Complains 中每条记录之间的时间差，保留时间差最小的那一对。
# Raw 表使用字段：提交时间（parsed datetime）
# Complains 表使用字段：就诊日期（parsed datetime）
# 对所有组合计算时间差（绝对值，单位秒）选择时间差最小的一对 仅保留这一行 Raw 及这一行 Complains 其余记录全部删除
# 这样保证共同 ID 在两个文件中都仅保留 最匹配的、最接近的时间点。
# 2. 仅在 Rawdata1 中出现的 ID
# 当某个 ID 出现在 Rawdata1 中，但不出现在 Complains 中时：
# 规则：保留 Rawdata1 中该 ID 的所有记录里 “提交时间最早” 的一条。
# 同时删除该 ID 的其他记录
# 这样保证 Raw 中的独有 ID 也只保留一条最合理的数据。
# 3. 仅在 Complains_YoungClients 中出现的 ID
# 当某个 ID 出现在 Complains 中，但 不出现在 Rawdata1 中时：
# 规则：保留 Complains 中该 ID 的所有记录里 “就诊日期最早” 的一条。
# 同时删除该 ID 的其他记录
# 这保证 Complains 中的独有 ID 也只保留一条最代表性的记录。
# 输出数据文件为：Raw_output.xlsx 也是后续检出率和EGA载入的数据文件。
library(readxl)
library(dplyr)
library(lubridate)
library(here)
library(openxlsx)

#==========================================================
# 1. 读取数据
#==========================================================
raw <- read_excel(here("DATA", "Rawdata1.xlsx"))
cmp <- read_excel(here("DATA", "Complains_YoungClients.xls"))

# 强制 ID 字段为字符
raw$ID <- as.character(raw$ID)
cmp$门诊ID <- as.character(cmp$门诊ID)

#==========================================================
# 2. 解析 Raw 的提交时间（英文格式 + 数字格式）
#==========================================================

# 去掉 " CST"
raw$提交时间_clean <- gsub(" CST", "", raw$提交时间, fixed = TRUE)

# 创建解析结果列
raw$提交时间_parsed <- NA

# --- 英文格式 (例: Wed May 25 14:04:35 2022) ---
idx_eng <- grepl("[A-Za-z]{3} [A-Za-z]{3} [0-9]{1,2}", raw$提交时间_clean)

old_locale <- Sys.getlocale("LC_TIME")
Sys.setlocale("LC_TIME", "C")   # 切到英文环境，识别 Wed / May

raw$提交时间_parsed[idx_eng] <- as.POSIXct(
  raw$提交时间_clean[idx_eng],
  format = "%a %b %d %H:%M:%S %Y",
  tz = "Asia/Shanghai"
)

Sys.setlocale("LC_TIME", old_locale)  # 解析完恢复

# --- 数字格式 (例: 2023-06-17 10:11:28) ---
idx_num <- grepl("^\\d{4}-\\d{2}-\\d{2}", raw$提交时间_clean)

raw$提交时间_parsed[idx_num] <- as.POSIXct(
  raw$提交时间_clean[idx_num],
  format = "%Y-%m-%d %H:%M:%S",
  tz = "Asia/Shanghai"
)

#==========================================================
# 3. 解析 Complains 的就诊日期
#==========================================================
cmp$就诊日期_parsed <- as.POSIXct(
  cmp$就诊日期,
  format = "%Y/%m/%d %H:%M:%S",
  tz = "Asia/Shanghai"
)

#==========================================================
# 4. ID 分类
#==========================================================
common_ids <- intersect(raw$ID, cmp$门诊ID)
only_raw_ids <- setdiff(raw$ID, cmp$门诊ID)
only_cmp_ids <- setdiff(cmp$门诊ID, raw$ID)

#==========================================================
# 5. 共同 ID —— Raw & Complains 时间最接近的一对
#==========================================================
matched_pairs <- raw %>%
  filter(ID %in% common_ids) %>%
  left_join(cmp, by = c("ID" = "门诊ID")) %>%
  mutate(
    time_diff = abs(as.numeric(
      difftime(提交时间_parsed, 就诊日期_parsed, units = "secs")
    )),
    time_diff = ifelse(is.na(time_diff), Inf, time_diff)
  ) %>%
  group_by(ID) %>%                          # 每个 ID 只留一行（时间最近）
  slice_min(time_diff, n = 1, with_ties = FALSE) %>%
  ungroup()

#==========================================================
# 6. Raw 独有 ID —— 保留提交时间最早
#==========================================================
raw_only <- raw %>%
  filter(ID %in% only_raw_ids) %>%
  group_by(ID) %>%
  slice_min(提交时间_parsed, n = 1, with_ties = FALSE) %>%
  ungroup()

#==========================================================
# 7. Complains 独有 ID —— 保留最早就诊时间
#==========================================================
cmp_only <- cmp %>%
  filter(门诊ID %in% only_cmp_ids) %>%
  group_by(门诊ID) %>%
  slice_min(就诊日期_parsed, n = 1, with_ties = FALSE) %>%
  ungroup()

#==========================================================
# 8. 组合 Raw 输出数据：每个 Raw ID 一行
#==========================================================
Raw_output <- bind_rows(
  matched_pairs %>% select(any_of(names(raw))),  # 共同 ID 的 Raw 行
  raw_only                                      # Raw 独有 ID
)

#==========================================================
# 9. 组合 Complains 输出数据：每个 门诊ID 一行
#==========================================================
# 先准备一份“来自 matched_pairs 的 Complains 视角”：把 ID 当成 门诊ID 用
cmp_cols <- names(cmp)

cmp_from_matched <- matched_pairs %>%
  mutate(门诊ID = ID) %>%            # 加回 Complains 的键
  select(all_of(cmp_cols))           # 按 Complains 原始列顺序取列

# 再和 Complains 独有的行拼在一起
Cmp_output <- bind_rows(
  cmp_from_matched,
  cmp_only
)

#==========================================================
# 10. 输出 Excel 文件（不会乱码）
#==========================================================
write.xlsx(Raw_output,
           here("OUTPUT", "Raw_output.xlsx"),
           overwrite = TRUE)

write.xlsx(Cmp_output,
           here("OUTPUT", "Complains_output.xlsx"),
           overwrite = TRUE)

cat("全部处理完成！Excel 文件已生成到 OUTPUT 文件夹（两个文件各自每个 ID 只保留一行）。\n")

```




```{r}
# 进一步对CMP_OUTPUT进行处理
# 1：删除现病史为空或者缺失的记录,只保留现病史有意义的记录
# 2：只保留诊断于抑郁有关的记录
# 3：看主诉这列，有多少人是代诊的，去掉那些父母待诊的记录
# 第一步
library(dplyr)

Cmp_step1 <- Cmp_output %>%
  filter(
    !is.na(现病史),              # 不是 NA
    trimws(现病史) != ""         # 去掉空格后不是空
  )

cat("删除现病史为空后的样本量：", nrow(Cmp_step1), "\n")
# 第二步
Cmp_step2 <- Cmp_step1 %>%
  filter(
    !is.na(诊断),
    grepl("抑郁", 诊断)
  )

cat("诊断包含“抑郁”的样本量：", nrow(Cmp_step2), "\n")
# 第三步
sum(grepl("代诊", Cmp_step2$主诉))
Cmp_step3 <- Cmp_step2 %>%
  filter(!grepl("代诊", 主诉))

```


```{r}
# 随机抽500个人
library(dplyr)
library(openxlsx)
library(here)

#================================================
# 1. 固定随机种子（保证可复现）
#================================================
set.seed(123)

#================================================
# 2. 从 Cmp_step3 中随机抽取 500 人
#================================================
Cmp_NLP_500 <- Cmp_step3 %>%
  sample_n(500)

#================================================
# 3. 简单校验
#================================================
nrow(Cmp_NLP_500)                      # 应为 500
any(duplicated(Cmp_NLP_500$门诊ID))   # 应为 FALSE

#================================================
# 4. 导出为 Excel
#================================================
output_path <- here("OUTPUT", "Complains_output_depression_500.xlsx")

write.xlsx(
  Cmp_NLP_500,
  file = output_path,
  overwrite = TRUE
)

cat("NLP 测试样本已导出：", output_path, "\n")


```






