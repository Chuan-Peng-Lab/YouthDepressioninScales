---
title: "实证数据分析"
author: "why"
date: "2024.9.5"
output: html_document
---
```{r}
# 数据处理完整思路
# 1：载入需要的数据。原始数据中除抑郁问卷外，还包括焦虑问卷，因此只载入测量抑郁的问卷，及人口学信息。具体为DSRSC、CDI、PHQ-9、和DASS-21中测量抑郁的题目。
# 2：转换数据为数值型。
# 3：处理缺失值（实际没有缺失值）。
# 4：原始数据-1，用以方便计算检出率。原始数据的范围与量表正常的数据范围是不一致的。例如：DSRSC量表的计分范围正常应该为0-2，检出率为≥15。但咱们收到的原始数据计分范围就是1-3，也就是所有数值都+了1。因此-1后才能计算正确的检出率。
# 5：描述统计，原始数据的年龄范围显示为0-29岁，因此参考李医生的建议，筛除了7岁以下和18岁以上的人。
# 计算了1、性别比例。2、年龄范围。
# 6：数据质量检查。首先，使用原始数据进行了相关分析，用以检查数据。
# 发现问题：1、DSRSC问卷内相关有正有负。2、CDI问卷内相关有正有负。因此，数据应该进行反向计分，与李医生讨论过确实需要进行反向计分。
# 7：反向计分，以及反向计分后的相关分析。

# 上为数据预处理，下面开始正式检验。

# 8: 我们对问卷内部的题目进行了合并，并且在跨问卷中认为一些题目是测量同一症状的。
# 因此，这些特定题目之间的相关，应该高于其他题目的相关。
# 对此，我们对特定题目的相关系数和其他题目的相关系数进行了Z检验。
# 大部分特定题目的相关系数是高于其他的，详细结果见8及8.1。


# 9：我们认为儿童青少年不同问卷之间的检出率应该有差异。因此进行了检出率计算。
# 结果显示：CDI的检出率为49.25，DSRSC的检出率为52.12.PHQ-9的检出率为53.46.


# 10：我们想要探究不同症状之间可以形成多少个cluster，因此进行了Exploratory Graph Analysis
# 由于不同问卷之间的题目，可能测量的是同一个症状，因此我们对其进行了合并，以取均值的形式，合并了不同问卷之间的题目。


# 载入必要的包
library(here)
library(bruceR)
library(tidyverse)
library(openxlsx)
library(ggcorrplot)
library(papaja)
```

```{r}
# 1. 载入数据
raw_data <- bruceR::import(here::here("data", "Rawdata1.xlsx"))

selected_data <- raw_data %>%
  select(ID, Gender, Age, 
         DSRSC1:DSRSC18, 
         PHQ1:PHQ9, 
         DASS3, DASS5, DASS10, DASS13, DASS16, DASS17, DASS21, 
         CDI1:CDI27)

# 2.转换数据类型，性别从“男”转换为1，“女”转换为2，其他变量转换为数值型
selected_data_numeric <- selected_data %>%
  mutate(Gender = factor(Gender, levels = c("男", "女"), labels = c(1, 2))) %>%
  mutate(across(matches("Gender|Age|DSRSC|PHQ|DASS|CDI"), as.numeric))


#3.处理缺失值
clean_data <- selected_data_numeric %>%
  drop_na()

#4.原始数据-1，用以方便计算检出率
transformed_data <- clean_data %>%
  mutate(across(matches("DSRSC|PHQ|DASS|CDI"), ~ .x - 1))

#5.筛选出年龄在7岁以上且不超过18岁的数据
filtered_data <- transformed_data %>%
  filter(Age >= 7 & Age <= 18)

# 描述统计
# 计算性别比例
gender_proportion <- filtered_data %>%
  summarise(
    male = sum(Gender == 1, na.rm = TRUE),
    female = sum(Gender == 2, na.rm = TRUE),
    total = n(),
    male_proportion = male / total * 100,
    female_proportion = female / total * 100
  )
# 打印性别比例
print(gender_proportion)

# 计算年龄的范围
age_range <- filtered_data %>%
  summarise(
    min_age = min(Age, na.rm = TRUE),
    max_age = max(Age, na.rm = TRUE)
  )

# 打印年龄范围
print(age_range)

```

```{r}
# 7.进行反向计分
# CDI 反向计分项目
CDI_reverse_items <- c("CDI2", "CDI5", "CDI7", "CDI8", "CDI10", 
                       "CDI11", "CDI13", "CDI15", "CDI16", 
                       "CDI18", "CDI21", "CDI24", "CDI25")

# DSRSC 反向计分项目
DSRSC_reverse_items <- c("DSRSC3", "DSRSC5", "DSRSC6", "DSRSC10", 
                         "DSRSC14", "DSRSC15", "DSRSC17", "DSRSC18")

# 对CDI和DSRSC项目进行反向计分
reversed_data <- filtered_data %>%
  mutate(across(all_of(CDI_reverse_items), ~ 2 - .)) %>%  # 对于0-2范围，反向计分为2减去原分数
  mutate(across(all_of(DSRSC_reverse_items), ~ 2 - .))
  

# 计算反向计分后的相关性
correlation_matrix_reversed <- reversed_data %>%
  select(matches("DSRSC|PHQ|DASS|CDI")) %>%
  cor(method = "spearman")  # 使用Spearman相关系数

# 导出
output_file_reversed <- here::here("output", "correlation_matrix_reversed_spearman.xlsx")
write.xlsx(correlation_matrix_reversed, output_file_reversed)
```



```{r}

# 9.计算检出率，以及不同条件下检出影响人数，并且可视化。
# 只有柱状图版本。
library(ggplot2)
library(here)

# 设置阈值
cutoff_DSRSC <- 15
cutoff_PHQ <- 10
cutoff_CDI <- 20  
cutoff_DASS_male <- 4   # 男性 DASS 检出阈值
cutoff_DASS_female <- 5 # 女性 DASS 检出阈值

# 计算总分
# CDI26题不得分
total_DSRSC_scores <- rowSums(reversed_data[, grep("^DSRSC", names(reversed_data))])
total_PHQ_scores <- rowSums(reversed_data[, grep("^PHQ", names(reversed_data))])
total_CDI_scores <- rowSums(reversed_data[, grep("^CDI", names(reversed_data))]) - reversed_data$CDI26
total_DASS_scores <- rowSums(reversed_data[, grep("^DASS", names(reversed_data))])  # 计算 DASS 总分

# 计算超过cutoff的人数
detected_DSRSC <- sum(total_DSRSC_scores >= cutoff_DSRSC)
detected_PHQ <- sum(total_PHQ_scores >= cutoff_PHQ)
detected_CDI <- sum(total_CDI_scores >= cutoff_CDI)

# DASS检出人数（根据性别的不同阈值）
detected_DASS_male <- sum(total_DASS_scores[reversed_data$Gender == 1] >= cutoff_DASS_male)
detected_DASS_female <- sum(total_DASS_scores[reversed_data$Gender == 2] >= cutoff_DASS_female)
detected_DASS <- detected_DASS_male + detected_DASS_female  # 总的 DASS 检出人数

# 计算总样本数量
total_count <- nrow(reversed_data)

# 计算检出率
detection_rate_DSRSC <- (detected_DSRSC / total_count) * 100
detection_rate_PHQ <- (detected_PHQ / total_count) * 100
detection_rate_CDI <- (detected_CDI / total_count) * 100
detection_rate_DASS <- (detected_DASS / total_count) * 100  # DASS 检出率

# 打印结果
cat("DSRSC总分超过cutoff的人数:", detected_DSRSC, "\n")
cat("DSRSC检出率:", detection_rate_DSRSC, "%\n")
cat("PHQ总分超过cutoff的人数:", detected_PHQ, "\n")
cat("PHQ检出率:", detection_rate_PHQ, "%\n")
cat("CDI总分超过cutoff的人数:", detected_CDI, "\n")
cat("CDI检出率:", detection_rate_CDI, "%\n")
cat("男性DASS检出人数:", detected_DASS_male, "\n")
cat("女性DASS检出人数:", detected_DASS_female, "\n")
cat("DASS总分超过cutoff的人数:", detected_DASS, "\n")
cat("DASS检出率:", detection_rate_DASS, "%\n")

# 创建检出率数据框
detection_rates <- data.frame(
  Measure = c("DSRSC", "PHQ-9", "CDI", "DASS"),  # 添加 DASS
  Detection_Rate = c(detection_rate_DSRSC, detection_rate_PHQ, detection_rate_CDI, detection_rate_DASS)
)

# 绘制图形
ggplot(detection_rates, aes(x = Measure, y = Detection_Rate, fill = Measure)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_manual(values = c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728")) +  # 添加 DASS 颜色
  labs(x = "Measure", y = "Detection Rate (%)") +
  theme_minimal(base_size = 15) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"),
    plot.title = element_blank(),
    legend.position = "none"
  ) +
  geom_text(aes(label = round(Detection_Rate, 2)), vjust = -0.5)

# 保存图像到figure文件夹
ggsave(here::here("figure", "detection_rates_plot.png"), width = 8, height = 5, dpi = 300)

# 计算特定个体

# PHQ-9检出，但DSRSC、CDI和DASS未检出的人
specific_phq_positive <- reversed_data[total_PHQ_scores >= cutoff_PHQ & 
                                       total_DSRSC_scores < cutoff_DSRSC & 
                                       total_CDI_scores < cutoff_CDI & 
                                       total_DASS_scores < ifelse(reversed_data$Gender == 1, cutoff_DASS_male, cutoff_DASS_female), ]
cat("在PHQ-9检出，但DSRSC、CDI和DASS未检出的人数:", nrow(specific_phq_positive), "\n")
if(nrow(specific_phq_positive) > 0) {
  print(specific_phq_positive)
}

# CDI检出，但PHQ-9、DSRSC和DASS未检出的人
specific_cdi_positive <- reversed_data[total_CDI_scores >= cutoff_CDI & 
                                       total_PHQ_scores < cutoff_PHQ & 
                                       total_DSRSC_scores < cutoff_DSRSC & 
                                       total_DASS_scores < ifelse(reversed_data$Gender == 1, cutoff_DASS_male, cutoff_DASS_female), ]
cat("在CDI检出，但PHQ-9、DSRSC和DASS未检出的人数:", nrow(specific_cdi_positive), "\n")
if(nrow(specific_cdi_positive) > 0) {
  print(specific_cdi_positive)
}

# DSRSC检出，但PHQ-9、CDI和DASS未检出的人
specific_dsrsc_positive <- reversed_data[total_DSRSC_scores >= cutoff_DSRSC & 
                                         total_PHQ_scores < cutoff_PHQ & 
                                         total_CDI_scores < cutoff_CDI & 
                                         total_DASS_scores < ifelse(reversed_data$Gender == 1, cutoff_DASS_male, cutoff_DASS_female), ]
cat("在DSRSC检出，但PHQ-9、CDI和DASS未检出的人数:", nrow(specific_dsrsc_positive), "\n")
if(nrow(specific_dsrsc_positive) > 0) {
  print(specific_dsrsc_positive)
}

# DASS检出，但PHQ-9、CDI和DSRSC未检出的人
specific_dass_positive <- reversed_data[total_DASS_scores >= ifelse(reversed_data$Gender == 1, cutoff_DASS_male, cutoff_DASS_female) & 
                                        total_PHQ_scores < cutoff_PHQ & 
                                        total_CDI_scores < cutoff_CDI & 
                                        total_DSRSC_scores < cutoff_DSRSC, ]
cat("在DASS检出，但PHQ-9、CDI和DSRSC未检出的人数:", nrow(specific_dass_positive), "\n")
if(nrow(specific_dass_positive) > 0) {
  print(specific_dass_positive)
}


```



```{r}
# treemap
# 计算不同条件检出的人数，即被一个量表，两个量表，三个量表检测出的人数各是多少。
library(tidyverse)
library(treemapify)
library(papaja)

# 标志矩阵
detection_flags <- data.frame(
  ID = reversed_data$ID,
  DSRSC = as.integer(total_DSRSC_scores >= cutoff_DSRSC),
  PHQ   = as.integer(total_PHQ_scores >= cutoff_PHQ),
  CDI   = as.integer(total_CDI_scores >= cutoff_CDI),
  DASS  = as.integer(total_DASS_scores >= ifelse(reversed_data$Gender == 1, cutoff_DASS_male, cutoff_DASS_female))
)

# 重新命名并标记等级
detection_flags <- detection_flags %>%
  mutate(
    total_detected = DSRSC + PHQ + CDI + DASS,
    group = case_when(
      total_detected == 4 ~ "All four detected",
      
      total_detected == 3 & DSRSC == 0 ~ "Only PHQ + CDI + DASS",
      total_detected == 3 & PHQ == 0 ~ "Only DSRSC + CDI + DASS",
      total_detected == 3 & CDI == 0 ~ "Only DSRSC + PHQ + DASS",
      total_detected == 3 & DASS == 0 ~ "Only DSRSC + PHQ + CDI",
      
      total_detected == 2 & DSRSC == 1 & PHQ == 1 ~ "Only DSRSC + PHQ",
      total_detected == 2 & DSRSC == 1 & CDI == 1 ~ "Only DSRSC + CDI",
      total_detected == 2 & DSRSC == 1 & DASS == 1 ~ "Only DSRSC + DASS",
      total_detected == 2 & PHQ == 1 & CDI == 1 ~ "Only PHQ + CDI",
      total_detected == 2 & PHQ == 1 & DASS == 1 ~ "Only PHQ + DASS",
      total_detected == 2 & CDI == 1 & DASS == 1 ~ "Only CDI + DASS",
      
      total_detected == 1 & DSRSC == 1 ~ "Only DSRSC",
      total_detected == 1 & PHQ == 1 ~ "Only PHQ",
      total_detected == 1 & CDI == 1 ~ "Only CDI",
      total_detected == 1 & DASS == 1 ~ "Only DASS",
      
      TRUE ~ "Other/Unclassified"
    ),
    level = case_when(
      total_detected == 4 ~ "4_detected",
      total_detected == 3 ~ "3_detected",
      total_detected == 2 ~ "2_detected",
      total_detected == 1 ~ "1_detected"
    )
  )

# 汇总
group_counts <- detection_flags %>%
  filter(group != "Other/Unclassified") %>%
  group_by(group, level) %>%
  summarise(count = n(), .groups = "drop") %>%
  filter(count > 0) %>% 
  arrange(desc(count))

# 输出各组合人数
cat("各组合检出人数如下：\n")
print(group_counts)

# 绘制 Treemap
p2 <- ggplot(group_counts, aes(area = count, fill = level, label = paste0(group, "\n", count))) +
  geom_treemap() +
  geom_treemap_text(colour = "white", place = "centre", grow = TRUE, reflow = TRUE) +
  papaja::theme_apa(base_size = 25) + 
  scale_fill_manual(
    values = c(
      "4_detected" = "#08306b",
      "3_detected" = "#2171b5",
      "2_detected" = "#6baed6",
      "1_detected" = "#c6dbef"
    )
  ) +
  labs(title = "Distribution of Detection Condition", fill = "Detected Level")

# 保存
ggsave(here::here("figure", "treemap_ordered.png"), width = 10, height = 6, dpi = 300)



# 导出不同条件的ID
# 给每个人标上总的检出类别（0,1,2,3,4）
detection_flags <- detection_flags %>%
  mutate(detected_category = paste0(total_detected, "_detected"))

# 按类别把 ID 分开，并导出到 Excel
ids_by_category <- split(reversed_data[, c("ID", "Gender", "Age")], detection_flags$detected_category)

output_file <- here::here("output", "IDs_by_detected_category.xlsx")
openxlsx::write.xlsx(ids_by_category, file = output_file)
cat("不同检出类别的 ID 已导出到:", output_file, "\n")



```






```{r}
# 以折线的形式加上了不同年龄检出率的图。
# 加载所需包
library(ggplot2)
library(here)
library(dplyr)
library(papaja)

# 计算原始检出率数据（总体）
detection_rates <- data.frame(
  Measure = c("DSRSC", "PHQ-9", "CDI", "DASS"),
  Detection_Rate = c(detection_rate_DSRSC, detection_rate_PHQ, detection_rate_CDI, detection_rate_DASS),
  Age_Group = "Overall"  # 改为“Overall”作为总体组别
)

# 创建年龄段列表
age_groups <- list(
  "7-12" = 7:12,
  "13-15" = 13:15,
  "16-18" = 16:18
)

# 年龄段人数统计（可选打印）
age_group_counts <- reversed_data %>%
  mutate(Age_Group = case_when(
    Age >= 7 & Age <= 12 ~ "7-12",
    Age >= 13 & Age <= 15 ~ "13-15",
    Age >= 16 & Age <= 18 ~ "16-18",
    TRUE ~ "Other"
  )) %>%
  group_by(Age_Group) %>%
  summarise(Count = n())

print(age_group_counts)

# 计算每个年龄段的检出率
age_detection_rates <- data.frame(
  Age_Group = character(0),
  Measure = character(0),
  Detection_Rate = numeric(0)
)

for (age_group in names(age_groups)) {
  age_range <- age_groups[[age_group]]
  age_data <- reversed_data[reversed_data$Age %in% age_range, ]
  
  detected_DSRSC_age <- sum(rowSums(age_data[, grep("^DSRSC", names(age_data))]) >= cutoff_DSRSC)
  detected_PHQ_age <- sum(rowSums(age_data[, grep("^PHQ", names(age_data))]) >= cutoff_PHQ)
  detected_CDI_age <- sum(rowSums(age_data[, setdiff(grep("^CDI", names(age_data), value = TRUE), "CDI26")]) >= cutoff_CDI)
  detected_DASS_male_age <- sum(rowSums(age_data[age_data$Gender == 1, grep("^DASS", names(age_data))]) >= cutoff_DASS_male)
  detected_DASS_female_age <- sum(rowSums(age_data[age_data$Gender == 2, grep("^DASS", names(age_data))]) >= cutoff_DASS_female)
  detected_DASS_age <- detected_DASS_male_age + detected_DASS_female_age
  
  total_age_count <- nrow(age_data)
  
  detection_rate_DSRSC_age <- (detected_DSRSC_age / total_age_count) * 100
  detection_rate_PHQ_age <- (detected_PHQ_age / total_age_count) * 100
  detection_rate_CDI_age <- (detected_CDI_age / total_age_count) * 100
  detection_rate_DASS_age <- (detected_DASS_age / total_age_count) * 100
  
  age_detection_rates <- rbind(age_detection_rates, 
                               data.frame(Age_Group = age_group, Measure = "DSRSC", Detection_Rate = detection_rate_DSRSC_age),
                               data.frame(Age_Group = age_group, Measure = "PHQ-9", Detection_Rate = detection_rate_PHQ_age),
                               data.frame(Age_Group = age_group, Measure = "CDI", Detection_Rate = detection_rate_CDI_age),
                               data.frame(Age_Group = age_group, Measure = "DASS", Detection_Rate = detection_rate_DASS_age))
}

# 合并总体与年龄段数据
combined_data <- rbind(detection_rates, age_detection_rates)

# 设置 Age_Group 为因子并排序
combined_data$Age_Group <- factor(combined_data$Age_Group, levels = c("Overall", "7-12", "13-15", "16-18"))

# 按平均检出率排序
mean_detection_rates <- combined_data %>%
  group_by(Measure) %>%
  summarise(Average_Detection_Rate = mean(Detection_Rate, na.rm = TRUE)) %>%
  arrange(desc(Average_Detection_Rate))

combined_data$Measure <- factor(combined_data$Measure, levels = mean_detection_rates$Measure)

# 画图（全为折线图）
p1 <- ggplot(combined_data, aes(x = Measure, y = Detection_Rate, group = Age_Group, color = Age_Group)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  papaja::theme_apa(base_size = 25) +
  labs(
    x = NULL, 
    y = "Detection Rate (%)", 
    title = "Detection Rates by Measure and Age Group"
  ) +
  scale_color_manual(
    values = c(
      "Overall" = "gray40",
      "7-12" = "#2ca02c",
      "13-15" = "#1f77b4",
      "16-18" = "#ff7f0e"
    )
  ) +
  scale_y_continuous(limits = c(0, 80), expand = c(0, 0)) +
  scale_x_discrete(expand = c(0.2, 0)) +
  guides(color = guide_legend(title = "Group"))

# 保存图像
ggsave(here::here("figure", "combined_detection_rates_plot_apa_lines_only.png"), width = 10, height = 6, dpi = 300)
```


```{r}
#拼图
library(patchwork)

combined_plot <- p1 + p2 +
  plot_layout(ncol = 2) +
  plot_annotation(
    tag_levels = 'A',        # 大写字母 A, B
    tag_prefix = "",         # 不加括号
    tag_suffix = "",         # 不加句点或括号
    theme = theme(
      plot.tag = element_text(size = 20, face = "bold")  # 设置字体大小和加粗
    )
  )


# 保存图像
ggsave(here::here("figure", "final_combined_plot.png"),
       combined_plot, width = 20, height = 6, dpi = 300)


```



```{r}
# 计算不同年龄的检出率，以及不同条件下检出影响人数，并且可视化。
# CDI可能有问题，算了26题。
# 创建年龄段数据
age_groups <- list(
  "7-12" = 7:12,
  "13-15" = 13:15,
  "16-18" = 16:18
)

# 创建数据框存储每个年龄段的检出率
age_detection_rates <- data.frame(
  Age_Group = character(0),
  Measure = character(0),
  Detection_Rate = numeric(0)
)

# 创建数据框存储不同年龄段的特定检出个体
specific_detection_counts <- data.frame(
  Age_Group = character(0),
  PHQ_Detected_only = integer(0),
  CDI_Detected_only = integer(0),
  DSRSC_Detected_only = integer(0),
  DASS_Detected_only = integer(0),
  stringsAsFactors = FALSE
)

# 循环遍历每个年龄段
for (age_group in names(age_groups)) {
  age_range <- age_groups[[age_group]]
  
  # 根据年龄筛选数据
  age_data <- reversed_data[reversed_data$Age %in% age_range, ]
  
  # 计算每个测量工具的检出率
  detected_DSRSC_age <- sum(rowSums(age_data[, grep("^DSRSC", names(age_data))]) >= cutoff_DSRSC)
  detected_PHQ_age <- sum(rowSums(age_data[, grep("^PHQ", names(age_data))]) >= cutoff_PHQ)
  detected_CDI_age <- sum(rowSums(age_data[, grep("^CDI", names(age_data))]) >= cutoff_CDI)
  detected_DASS_male_age <- sum(rowSums(age_data[age_data$Gender == 1, grep("^DASS", names(age_data))]) >= cutoff_DASS_male)
  detected_DASS_female_age <- sum(rowSums(age_data[age_data$Gender == 2, grep("^DASS", names(age_data))]) >= cutoff_DASS_female)
  detected_DASS_age <- detected_DASS_male_age + detected_DASS_female_age
  
  # 总样本数
  total_age_count <- nrow(age_data)
  
  # 检出率
  detection_rate_DSRSC_age <- (detected_DSRSC_age / total_age_count) * 100
  detection_rate_PHQ_age <- (detected_PHQ_age / total_age_count) * 100
  detection_rate_CDI_age <- (detected_CDI_age / total_age_count) * 100
  detection_rate_DASS_age <- (detected_DASS_age / total_age_count) * 100
  
  # 添加检出率数据
  age_detection_rates <- rbind(age_detection_rates, 
                               data.frame(Age_Group = age_group, 
                                          Measure = "DSRSC", 
                                          Detection_Rate = detection_rate_DSRSC_age))
  age_detection_rates <- rbind(age_detection_rates, 
                               data.frame(Age_Group = age_group, 
                                          Measure = "PHQ-9", 
                                          Detection_Rate = detection_rate_PHQ_age))
  age_detection_rates <- rbind(age_detection_rates, 
                               data.frame(Age_Group = age_group, 
                                          Measure = "CDI", 
                                          Detection_Rate = detection_rate_CDI_age))
  age_detection_rates <- rbind(age_detection_rates, 
                               data.frame(Age_Group = age_group, 
                                          Measure = "DASS", 
                                          Detection_Rate = detection_rate_DASS_age))
  
  # 计算特定检出个体并输出
  cat("\n计算特定检出个体：\n")
  
  # 根据性别设置DASS的cutoff值
  age_data$DASS_cutoff <- ifelse(age_data$Gender == 1, cutoff_DASS_male, cutoff_DASS_female)
  
  # PHQ-9检出，但DSRSC、CDI和DASS未检出的人
  specific_phq_positive <- age_data[total_PHQ_scores[reversed_data$Age %in% age_range] >= cutoff_PHQ & 
                                    total_DSRSC_scores[reversed_data$Age %in% age_range] < cutoff_DSRSC & 
                                    total_CDI_scores[reversed_data$Age %in% age_range] < cutoff_CDI & 
                                    total_DASS_scores[reversed_data$Age %in% age_range] < age_data$DASS_cutoff, ]
  cat(paste("年龄段", age_group, "在PHQ-9检出，但DSRSC、CDI和DASS未检出的人数:", nrow(specific_phq_positive), "\n"))
  if (nrow(specific_phq_positive) > 0) {
    print(specific_phq_positive)
  }

  # CDI检出，但PHQ-9、DSRSC和DASS未检出的人
  specific_cdi_positive <- age_data[total_CDI_scores[reversed_data$Age %in% age_range] >= cutoff_CDI & 
                                    total_PHQ_scores[reversed_data$Age %in% age_range] < cutoff_PHQ & 
                                    total_DSRSC_scores[reversed_data$Age %in% age_range] < cutoff_DSRSC & 
                                    total_DASS_scores[reversed_data$Age %in% age_range] < age_data$DASS_cutoff, ]
  cat(paste("年龄段", age_group, "在CDI检出，但PHQ-9、DSRSC和DASS未检出的人数:", nrow(specific_cdi_positive), "\n"))
  if (nrow(specific_cdi_positive) > 0) {
    print(specific_cdi_positive)
  }

  # DSRSC检出，但PHQ-9、CDI和DASS未检出的人
  specific_dsrsc_positive <- age_data[total_DSRSC_scores[reversed_data$Age %in% age_range] >= cutoff_DSRSC & 
                                      total_PHQ_scores[reversed_data$Age %in% age_range] < cutoff_PHQ & 
                                      total_CDI_scores[reversed_data$Age %in% age_range] < cutoff_CDI & 
                                      total_DASS_scores[reversed_data$Age %in% age_range] < age_data$DASS_cutoff, ]
  cat(paste("年龄段", age_group, "在DSRSC检出，但PHQ-9、CDI和DASS未检出的人数:", nrow(specific_dsrsc_positive), "\n"))
  if (nrow(specific_dsrsc_positive) > 0) {
    print(specific_dsrsc_positive)
  }

  # DASS检出，但PHQ-9、CDI和DSRSC未检出的人
  specific_dass_positive <- age_data[total_DASS_scores[reversed_data$Age %in% age_range] >= age_data$DASS_cutoff & 
                                     total_PHQ_scores[reversed_data$Age %in% age_range] < cutoff_PHQ & 
                                     total_CDI_scores[reversed_data$Age %in% age_range] < cutoff_CDI & 
                                     total_DSRSC_scores[reversed_data$Age %in% age_range] < cutoff_DSRSC, ]
  cat(paste("年龄段", age_group, "在DASS检出，但PHQ-9、CDI和DSRSC未检出的人数:", nrow(specific_dass_positive), "\n"))
  if (nrow(specific_dass_positive) > 0) {
    print(specific_dass_positive)
  }
  
  # 将各个年龄段的特定检出个体数量添加到数据框
  specific_detection_counts <- rbind(specific_detection_counts, data.frame(
    Age_Group = age_group,
    PHQ_Detected_only = nrow(specific_phq_positive),
    CDI_Detected_only = nrow(specific_cdi_positive),
    DSRSC_Detected_only = nrow(specific_dsrsc_positive),
    DASS_Detected_only = nrow(specific_dass_positive)
  ))
}

# 打印检出率和特定检出个体人数
print(age_detection_rates)
print(specific_detection_counts)
```


```{r}
# 计算不同抑郁状况的占比
# 计算四个量表的总分（包括 DSRSC）
score_data <- reversed_data %>%
  rowwise() %>%
  mutate(
    PHQ_total = sum(c_across(starts_with("PHQ")), na.rm = TRUE),
    CDI_total = sum(c_across(starts_with("CDI"))[!names(.) %in% "CDI26"], na.rm = TRUE),
    DASS_total_raw = sum(c_across(starts_with("DASS")), na.rm = TRUE),
    DASS_total = DASS_total_raw * 2,  # Multiply DASS total by 2
    DSRSC_total = sum(c_across(starts_with("DSRSC")), na.rm = TRUE)
  ) %>%
  ungroup()

# 2. 根据总分范围分类抑郁状况，添加量表前缀避免标签重复
score_data <- score_data %>%
  mutate(
    PHQ_status = case_when(
      PHQ_total < 5 ~ "Minimal",
      PHQ_total >= 5 & PHQ_total < 10 ~ "Mild(PHQ)",
      PHQ_total >= 10 & PHQ_total < 15 ~ "Moderate(PHQ)",
      PHQ_total >= 15 & PHQ_total < 20 ~ "Moderately Severe",
      PHQ_total >= 20 & PHQ_total <= 27 ~ "Severe(PHQ)"
    ),
    CDI_status = case_when(
      CDI_total < 19 ~ "No Symptoms",
      CDI_total >= 19 & CDI_total < 25 ~ "Mild Symptoms",
      CDI_total >= 25 & CDI_total <= 54 ~ "Moderate-Severe Symptoms"
    ),
    DASS_status = case_when(
      DASS_total <= 9 ~ "Normal",
      DASS_total > 9 & DASS_total <= 13 ~ "Mild",
      DASS_total > 13 & DASS_total <= 20 ~ "Moderate",
      DASS_total > 20 & DASS_total <= 27 ~ "Severe",
      DASS_total > 27 & DASS_total <= 42 ~ "Extremely Severe"
    ),
    DSRSC_status = if_else(DSRSC_total >= 15, "Detected", "Not Detected")
  )

# 3. 数据整形以便绘图
plot_data <- score_data %>%
  pivot_longer(cols = c(PHQ_status, CDI_status, DASS_status, DSRSC_status), 
               names_to = "scale", values_to = "status") %>%
  mutate(scale = factor(scale, levels = c("PHQ_status", "CDI_status", "DASS_status", "DSRSC_status"),
                        labels = c("PHQ-9", "CDI", "DASS", "DSRSC")))

# 4. 计算每个量表各个状况的比例
plot_data_summary <- plot_data %>%
  group_by(scale, status) %>%
  summarise(count = n()) %>%
  mutate(proportion = count / sum(count) * 100) %>%
  mutate(status = factor(status, levels = c(
      "Minimal", "Mild(PHQ)", "Moderate(PHQ)", "Moderately Severe", "Severe(PHQ)",
      "No Symptoms", "Mild Symptoms", "Moderate-Severe Symptoms",
      "Normal", "Mild", "Moderate", "Severe", "Extremely Severe",
      "Not Detected", "Detected"
  )))

# 打印各个量表各个状况的比例
print(plot_data_summary)

```




